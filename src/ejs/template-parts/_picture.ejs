<%
/**
 * @src = src,extns,
*/

//属性を代入
let options = img.attr;

//
const breakPoint = global.breakPoint;
const path = global.path ? global.path : '';

//webp対応するかどうか
const hasWebp = ( 'webp' in img ) ? img.webp : false;

//メディアクエリに対応するかどうか
const hasMediaQuery = ( img.isMediaQuery ) && ( Object.keys(breakPoint).length !== 0 );

//属性のデフォルト、設定ない場合に代入しておく
if (!( 'alt' in options )) options.alt = '';
if (!( 'loading' in options )) options.loading = 'lazy';
if (!( 'decoding' in options )) options.decoding = 'async';

//メディアクエリ用の出力ソース初期化
let mqSource  = ``;

//ブレイクポイントもしくはseparateがtrueの場合に、ブレイクポイントに合わせた画像を出力する
if( hasMediaQuery ) {

	Object.keys(breakPoint).forEach( key => {

		let webp = ``;
		let mq = ``;

		mq += `\<source media="(max-width: ${breakPoint[key]}px)" srcset="`;

		//srcsetの指定がある場合の出力
		if(img.srcset) {
			img.srcset.forEach( size => {
				mq += `${path}images/${img.src}-${key}@${size}.${img.extns} ${size}, `;
			});
		}

		mq += `${path}images/${img.src}-${key}.${img.extns}`;
		mq += img.srcset ? ' 1x"' : '"';

		//srcsetをそのままWebp用に拡張子だけ置き換える
		webp += mq.replace( new RegExp(img.extns, 'g'), `${img.extns}.webp` );
		webp += ` type="image/webp">`;

		mq += `>`;
		
		//hasWebpがtrueならwebpの出力も追加
		mqSource += hasWebp ? webp + mq : mq;

	});

}

//attrの初期化
let attr = '';

let srcset = ``;
let webpSource = ``;

//srcset属性の追加
if ( 'srcset' in img ) {

	img.srcset.forEach( size => {
		srcset += `${path}images/${img.src}@${size}.${img.extns} ${size}, `;
	});
	srcset += `${path}images/${img.src}.${img.extns} 1x`;
	attr += ` srcset="${srcset}"`;
	attr += ` sizes="(max-width: ${options.width}px) 100vw, ${options.width}px"`;

}

	webpSource += `\<source `;
	webpSource += 'srcset' in img ? attr.replace( new RegExp(img.extns, 'g'), `${img.extns}.webp` ) : ` srcset="${path}images/${img.src}.${img.extns}.webp"`;
	webpSource += ` type="image/webp">`

//属性を出力形式にする
Object.keys(options).forEach( key => {
	attrName = key === 'className' ? 'class' : key;
	attr += ' ' + attrName + '="' + options[key] + '"';
});

//出力変数の初期化
let imageSource = '';

if( hasMediaQuery || hasWebp ) { %><picture><% }

	imageSource += hasMediaQuery ? mqSource : ``;

	imageSource += hasWebp ? webpSource : ``;

	imageSource += `\<img src="${path}images/${img.src}.${img.extns}"${attr}>`;

	console.log( imageSource );

%><%- imageSource %><% if( hasMediaQuery || hasWebp ) { %></picture><% } %>